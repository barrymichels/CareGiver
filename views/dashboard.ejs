<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title><%= getPageTitle("Dashboard") %></title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="/css/header.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#646cff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CareGiver">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
</head>
<body>
    <%- include('partials/header', { user }) %>
    
    <main class="dashboard-content">
        <div class="week-view">
            <div class="week-header">
                <div class="week-navigation">
                    <% if (weekOffset > -4) { %>
                        <a href="/?weekOffset=<%= weekOffset - 1 %>" class="nav-button prev-week">
                            &larr; Previous Week
                        </a>
                    <% } %>
                    
                    <h2 class="week-title"><%= weekTitle %></h2>
                    
                    <% if (weekOffset < 1) { %>
                        <a href="/?weekOffset=<%= weekOffset + 1 %>" class="nav-button next-week">
                            Next Week &rarr;
                        </a>
                    <% } %>
                </div>
            </div>
            
            <div class="schedule-grid">
                <% 
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const timeSlots = [
                    { time: '8:00am', label: 'Morning' },
                    { time: '12:30pm', label: 'Afternoon' },
                    { time: '5:00pm', label: 'Evening' },
                    { time: '9:30pm', label: 'Night' }
                ];

                // Helper function to parse time string to hours and minutes
                function parseTimeStr(timeStr) {
                    const [hours, minutes, period] = timeStr.match(/(\d+):(\d+)(am|pm)/).slice(1);
                    return {
                        hours: (period === 'pm' && hours !== '12' ? parseInt(hours) + 12 : parseInt(hours)),
                        minutes: parseInt(minutes)
                    };
                }

                // Get current time in local timezone
                const now = new Date();
                const currentTime = {
                    hours: now.getHours(),
                    minutes: now.getMinutes()
                };

                // Create weekStart in local timezone from UTC timestamp
                const localWeekStart = new Date(weekStartUTC);

                // Generate dates for the week
                const weekDates = days.map((day, index) => {
                    const date = new Date(localWeekStart);
                    date.setDate(localWeekStart.getDate() + index);
                    return {
                        name: day,
                        date: date,
                        formatted: date.toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric'
                        })
                    };
                });

                // Helper function to compare times
                function isTimeAfter(time1, time2) {
                    return (time1.hours * 60 + time1.minutes) > (time2.hours * 60 + time2.minutes);
                }

                // Helper function to find next timeslot
                function findNextTimeslot(currentDay, currentTime) {
                    let foundToday = false;
                    for (const day of weekDates) {
                        // Create date objects for comparison
                        const dayStart = new Date(day.date);
                        dayStart.setHours(0, 0, 0, 0);
                        const nowStart = new Date(now);
                        nowStart.setHours(0, 0, 0, 0);
                        
                        // Skip past days
                        if (dayStart < nowStart) continue;
                        
                        // If it's today, only show future slots
                        if (dayStart.getTime() === nowStart.getTime()) {
                            foundToday = true;
                            for (const slot of timeSlots) {
                                const slotTime = parseTimeStr(slot.time);
                                if (!isTimeAfter(currentTime, slotTime)) {
                                    return { day, slot };
                                }
                            }
                        }
                        // For future days, first slot is next
                        else if (foundToday || dayStart > nowStart) {
                            return { day, slot: timeSlots[0] };
                        }
                    }
                    return null;
                }

                const nextSlot = findNextTimeslot(weekDates[0], currentTime);
                %>
                
                <% weekDates.forEach(day => { %>
                    <div class="day-column">
                        <div class="day-header">
                            <div class="day-name"><%= day.name %></div>
                            <div class="day-date"><%= day.formatted %></div>
                        </div>
                        <div class="day-content">
                            <% timeSlots.forEach(slot => { 
                                const isNextSlot = nextSlot && 
                                    nextSlot.day.date.getTime() === day.date.getTime() && 
                                    nextSlot.slot.time === slot.time;
                            %>
                                <div class="time-slot <%= isNextSlot ? 'next-slot' : '' %>">
                                    <div class="time-slot-header">
                                        <span class="time"><%= slot.time %></span>
                                        <span class="label"><%= slot.label %></span>
                                    </div>
                                    <div class="time-slot-content">
                                        <% const assignment = assignments.find(a => 
                                            a.day_date === day.date.toLocaleDateString('en-CA') && 
                                            a.time_slot === slot.time
                                        ); %>
                                        <div class="assignment <%= assignment ? 'assigned' : 'open' %>">
                                            <%= assignment ? assignment.user_name : 'Open' %>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                <% }) %>
            </div>
        </div>

        <%- include('partials/availability-manager', { 
            days,
            timeSlots,
            userAvailability 
        }) %>
    </main>

    <%- include('partials/unsaved-changes-modal') %>

    <script src="/js/header.js"></script>
    <script src="/js/availability.js"></script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').then(registration => {
            console.log('ServiceWorker registered');
          }).catch(err => {
            console.log('ServiceWorker registration failed:', err);
          });
        });
      }
    </script>
</body>
</html>